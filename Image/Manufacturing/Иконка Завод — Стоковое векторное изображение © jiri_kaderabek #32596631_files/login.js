(function($){$.widget('depositphotos.depositLogin',{options:{selector:'form[data-space]',url:'//'+window.location.host+'/login.html'},_init:function(){this.$this=this.element;this._counter=0;this._credentials={username:'',password:''};this._space=undefined;this.targets=this._gather();this.handlers=this._handlers();dp.core.binder(this.targets,this.handlers,this.widgetFullName||this.widgetBaseClass);this._addObserver();},_addObserver:function(){var _this=this;dp.observer.add('depositLogin','pushstate',function(){_this._redirect=_this._getRedirect(window.location.href);});},_destroy:function(){dp.observer.remove(this.widgetName);dp.core.unbinder(this.targets,this.handlers,this.widgetFullName||this.widgetBaseClass);this.targets=this.handlers=undefined;},_gather:function(){var $mainForm=this.$this.find(this.options.selector);var $satelliteForm=$('form.d-login');var $mixedForms=$mainForm.add($satelliteForm);return{$wrapper:this.$this,main:{$popup:dp.popup.get('login'),$form:$mainForm,$inputs:this.$this.find('input[name="username"], input[name="password"]'),$username:this.$this.find('input[name="username"]'),$password:this.$this.find('input[name="password"]'),$submit:this.$this.find('input[type="submit"]'),$reset:this.$this.find('[data-action="password-recovery"]')},satellite:{$form:$satelliteForm,$submit:$satelliteForm.find('input[type="submit"]')},mixed:{$form:$mixedForms,$submit:$mixedForms.find('input[type="submit"]')}}},_handlers:function(){var _this=this;return{wrapper:{handler:function(){if(!$.browser.mobile){dp.tools.focusOnStraightBrowsersInput(_this.targets.main.$inputs.eq(0));}},events:'tipsShowed',run:function(){_this._redirect=_this._getRedirect(window.location.href);if(_this._redirect===false){if(_this.targets.$wrapper.attr('data-redirect')){_this._redirect=_this._getRedirect(_this.targets.$wrapper.attr('data-redirect'));}else if(_this.targets.main.$form.attr('data-redirect')){_this._redirect=_this._getRedirect(_this.targets.main.$form.attr('data-redirect'));}}}},mixed:{form:{handler:function(e){e.preventDefault();e.stopPropagation();_this._space=this.getAttribute('data-space');_this._handle();},events:'submit'},submit:{run:'depositLoading'}},main:{popup:{run:function(){dp.popup.callback('login','hide',function(){dp.track.fire('b_login_popupClose');},true);dp.popup.callback('login','show',function($pop,caller){$pop.find('input[name="username"]').focus();var href=window.location.href;if(caller){var hrefAttr=caller.getAttribute('href');if(hrefAttr&&hrefAttr.indexOf('/')!=-1)href=hrefAttr;var space=caller.getAttribute('data-space');if(space)dp.track.fire('b_login_popupAutoShow');}
_this._redirect=href;dp.track.page('/ingoing/login_form');dp.social.init($pop);},true);}},reset:{handler:function(e){e.preventDefault();dp.popup.hide('login');dp.popup.load('password-recovery',function(){dp.recovery.pass();});},events:'click'},inputs:{handler:function(e){if(e.which===13||e.keyCode===13){e.preventDefault();e.stopPropagation();_this._space=_this.targets.mixed.$form.attr('data-space');_this._handle();}},events:['keydown'],run:'depositFieldIndicate'}}}},_needPopup:function(){return['popup','landing','single'].indexOf(this._space)!==-1;},_trimUsername:function($inputs){var $username=$inputs.filter('[name=username]');$username.val($username.val().trim());return $inputs;},_handle:function(){var _this=this;var $inputs=_this._trimUsername(this.targets.main.$inputs);if(!_this._needPopup()){$inputs=this.targets.satellite.$form.filter('[data-space="'+this._space+'"]').find('input[name="username"], input[name="password"]');}
$inputs.each(function(){_this._credentials[this.name]=this.value;});var result=this._validate();this.targets.main.$inputs.trigger('reset');if(result===true){this._authenticate();}else{this._onValidationFail(result);}},_validate:function(){var errors={};for(var i in this._credentials){var result=[];var validationResults=[];if(!this._credentials.hasOwnProperty(i))continue;if(!this._credentials[i].length)result.push(true);if(i!=='password'){validationResults=dp.validator.validate(i,this._credentials[i]);}
errors[i]=dp.tools.mergeToArray(result,validationResults);}
if((errors.username.length+errors.password.length)!==0)return errors;return true;},_onValidationFail:function(result){dp.track.fire('b_login_'+this._space+'_fail');if(!this._needPopup())this._showWindow();return this._showErrors(result);},_showWindow:function(){var _this=this;dp.popup.callback('login','init',function(){for(var i in _this._credentials){if(!_this._credentials.hasOwnProperty(i))continue;this.find('input[name="'+i+'"]').val(_this._credentials[i]).trigger('reset');if($.browser['msie'])this.find('input[name="'+i+'"]').trigger('change');}});dp.popup.show('login');},_showErrors:function(errors){if(errors.hasOwnProperty('username')&&errors.hasOwnProperty('password')&&errors.username[0]===true&&errors.password[0]===true&&!this._needPopup())return false;dp.validator.showErrors(this.targets.main,errors);return false;},_authenticate:function(){var _this=this;var uuid=getUUID();var $caller=this.targets[this._space==='popup'||this._space==='single'?'main':'satellite'].$submit;var ajaxOptions={$caller:$caller,jsonp:false,jsonpCallback:'depositLogin_'+uuid,data:{callback:'depositLogin_'+uuid,username:$.trim(this._credentials.username),password:this._credentials.password},xhrFields:{withCredentials:true},success:function(data,$caller){_this._response(data,$caller);},error:function(jqXHR,textStatus,errorThrown){if(errorThrown==='timeout'&&_this._counter++<2){_this._authenticate();}else{_this._showErrors({'username':[tr('e_network_error')]});}}};if(this._redirect!==false){ajaxOptions.data.redirect=this._redirect;}
if(dp.config.isHttpsAllowed&&window.location.protocol.search('https')===-1){ajaxOptions.dataType='jsonp';ajaxOptions.data.dataType='jsonp';ajaxOptions.url='https:'+_this.options.url;ajaxOptions.timeoutTime=6000;}else{ajaxOptions.data.dataType='json';ajaxOptions.url=_this.options.url;};dp.core.ajax(ajaxOptions);},_response:function(data,$caller){if(data.errors&&data.errors!==false){this._onValidationFail(data.errors);$caller.trigger('loaded',false);}else{try{dp.storage.remove('u-guest');dp.storage.renew(data.data['user_settings']);}catch(e){$.error('jquery.depositLogin.js: cannot update user settings while successfully logged in');}
dp.track.fire('b_login_'+this._space);if(this._bigFuckingCrutch(data))return;if(data.data.redirect){if(window.location.href===data.data.redirect){location.reload();}else{window.location.href=data.data.redirect.replace('https://','http://');}}}},_getRedirect:function(url){var dpUrl=dp.url(url);if(typeof dpUrl.param('backURL[page]')!=='undefined'){return decodeURIComponent(dpUrl.param('backURL[page]'));}
return url;},_bigFuckingCrutch:function(data){var dpUrl=dp.url(window.location.href);var backUrl=dp.storage.get('backUrl');if(dpUrl.attr('path').search('signup.')!==-1){if(backUrl&&(data.data.user_balance.credits>0||data.data.user_balance.subscriptionCount>0||data.data.user_balance.imagepacksCount>0)){window.location.href=backUrl;return true;}}
return false;}});})(jQuery);
;dp.tips.callbacks.loginForm=function($target,$this){dp.social.init($target);$target.not('.disable-login').depositLogin();dp.social.init($target);};
;