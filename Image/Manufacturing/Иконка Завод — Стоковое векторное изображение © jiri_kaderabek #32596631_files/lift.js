(function($,undefined){$.widget('depositphotos.depositLift',{options:{dragMarker:undefined,container:'.lb-panel-container',rowItemSettings:{item:undefined,customHeight:undefined},btnUp:'.lb-header-right .up-bicon',btnDown:'.lb-header-right .down-bicon',minLevel:1,maxLevel:4,defaultLevel:2,animateMovement:true,settingsKeyPref:'',animateSpeed:500,checkResizeTimeout:500,callbacks:{afterUp:undefined,afterDown:undefined,onLevel:[]},thumbs:{small:undefined,medium:undefined},confThumbs:undefined},_dragScope:{storedHeight:undefined,minHeight:undefined,maxHeight:undefined,initCursorPos:undefined,lastCursorPos:undefined,moveDirection:undefined},_init:function(){this.$this=this.element;this.targets=this._gather();this.handlers=this._handlers();dp.core.binder(this.targets,this.handlers,this.widgetFullName||this.widgetBaseClass);},_destroy:function(){dp.core.unbinder(this.targets,this.handlers,this.widgetFullName||this.widgetBaseClass);this.targets=this.handlers=undefined;},_gather:function(){return{widget:{$element:this.$this},system:{$window:$(window),$document:$(document),$body:$('body')},elements:{$container:this.$this.find(this.options.container),$item:this._getRowItem(),$indicator:this.$this.find('.lift-indicator-icon i'),$tipsAndSettings:$('.d_have_tips, .d_lbp_settings')},controls:{$btnUp:this.$this.find(this.options.btnUp),$btnDown:this.$this.find(this.options.btnDown),$dragMarker:this.$this.find(this.options.dragMarker)}};},_handlers:function(){var _this=this;return{widget:{element:{handler:function(e,height){_this.options.confThumbs=height;switch(e.type){case'liftAdjustment':_this.targets.elements.$item=_this._getRowItem();_this._liftAdjustment();break;case'externalLiftUp':_this.targets.controls.$btnUp.trigger('click');break;}},events:['liftAdjustment','externalLiftUp'],run:function(){dp.storage.remove('cLiftLvl');if(_this.options.settingsKeyPref&&_this.options.settingsKeyPref.length>0){_this._settingsKey=_this.options.settingsKeyPref+'_currentLevel';}else{_this._settingsKey='currentLevel';}
_this._contHeight=_this.targets.elements.$container.height();_this._rowHeight=_this._getRowHeight();_this._minLevel=_this.options.minLevel;_this._maxLevel=_this._calculateMaxLevel();_this._curLvl=_this._getLevel();_this._setControlState(_this._curLvl);}}},controls:{dragMarker:{handler:function(e){if(e.which===1){_this._dragScope.initCursorPos=e.pageY;_this._dragScope.storedHeight=_this.targets.elements.$container.height();_this._dragScope.minHeight=_this._contHeight*_this._minLevel;_this._dragScope.maxHeight=_this._contHeight*_this._maxLevel;$(this).data('unlock',true);if(!_this.targets.system.$body.hasClass('d_unselectable')){_this.targets.system.$body.addClass('d_unselectable');}}},events:'mousedown'},btnUp:{handler:function(e){if(!_this.targets.controls.$btnUp.data('busy')){_this._liftUp(function(){if(typeof _this.options.callbacks.afterUp==='function'){_this.options.callbacks.afterUp();}});}}},btnDown:{handler:function(e){if(!_this.targets.controls.$btnDown.data('busy')){_this._liftDown(function(){if(typeof _this.options.callbacks.afterDown==='function'){_this.options.callbacks.afterDown();}});}}}},system:{window:{handler:function(e){switch(e.type){case'resize':clearTimeout(_this.doit);_this.doit=setTimeout(function(){_this._checkWindowHeight();},_this.options.checkResizeTimeout);break;}},events:'resize'},document:{handler:function(e){switch(e.type){case'mouseup':if(!_this.targets.controls.$dragMarker.data('unlock'))return;_this.targets.controls.$dragMarker.data('unlock',false);_this.targets.system.$body.removeClass('d_unselectable');_this._scrollToNearestLevel(_this._dragScope.moveDirection);break;case'mousemove':var newHeight;if(!_this.targets.controls.$dragMarker.data('unlock'))return;if(typeof _this._dragScope.lastCursorPos!=='undefined'){_this._dragScope.moveDirection=(_this._dragScope.lastCursorPos-e.pageY>0)?'top':'bottom';}
_this._dragScope.lastCursorPos=e.pageY;newHeight=_this._dragScope.storedHeight+(_this._dragScope.initCursorPos-e.pageY);if(newHeight>=0&&newHeight>=_this._dragScope.minHeight&&newHeight<=_this._dragScope.maxHeight){if(_this._dragScope.moveDirection==='top'&&parseInt(_this.targets.elements.$container.css('padding-top'))===0){_this.targets.elements.$container.attr('style','').removeAttr('style');}
_this.targets.elements.$container.css('height',newHeight+'px');}
break;}},events:['mouseup','mousemove']}}}},_getRowItem:function(){return this.$this.find(this.options.rowItemSettings.item+':visible').eq(0);},_liftAdjustment:function(){var level=this._getLevel();var itemHeight=this.targets.elements.$item.outerHeight(true)||this.options.thumbs[this.options.confThumbs];if(!itemHeight){return;}
if(itemHeight!==this._contHeight){this._contHeight=itemHeight;this._rowHeight=this._getRowHeight();this.targets.elements.$container.css('height',this._contHeight*level+"px");this.targets.elements.$container.attr('data-level',level).trigger('level.dbl');this.targets.elements.$tipsAndSettings.trigger('position.depositTips');this.targets.elements.$container.trigger('resizeContainer.dbl');}
this._checkWindowHeight();},_getRowHeight:function(){if(!this.targets.elements.$item.length){if(this.options.rowItemSettings.customHeight){return this.options.rowItemSettings.customHeight;}else{return this._contHeight;}}
return this.targets.elements.$item.outerHeight(true);},_calculateMaxLevel:function(){var level=Math.floor(this.targets.system.$window.height()/this._rowHeight);if(this.targets.widget.$element.height()+this._contHeight*(level-this._curLvl)>=this.targets.system.$window.height()){level--;}
return this.options.maxLevel<level?this.options.maxLevel:level;},_getLevel:function(){var levelFromStorage=dp.storage.get(this._settingsKey);var level;if(levelFromStorage){return parseInt(levelFromStorage);}else{level=this.options.defaultLevel>0?this.options.defaultLevel:Math.floor(this._contHeight/this._rowHeight);this._saveLevel(level);return level;}},_saveLevel:function(level){this._curLvl=level;dp.storage.set(this._settingsKey,level);},_setControlState:function(level){var indicatorCount=this.targets.elements.$indicator.length;this.targets.controls.$btnUp.removeClass('disabled');this.targets.controls.$btnDown.removeClass('disabled');if(level<=this._minLevel){this.targets.controls.$btnDown.addClass('disabled');}
if(level>=this._maxLevel){this.targets.controls.$btnUp.addClass('disabled');}
if(indicatorCount===level){this.targets.elements.$indicator.addClass('active');}else{this.targets.elements.$indicator.removeClass('active').filter(':gt('+(indicatorCount-level-1)+')').addClass('active');}
this.targets.elements.$indicator.css('visibility','visible').filter(':lt('+(indicatorCount-this._maxLevel)+')').css('visibility','hidden');this.targets.elements.$container.trigger('resizeContainer.dbl');this.targets.elements.$container.attr('data-level',level).trigger('level.dbl');dp.observer.fire('liftLevelChange',[level]);},_liftUp:function(callback){var _this=this;var newLvl=this._curLvl+1;this.targets.controls.$btnUp.data('busy',true);if(newLvl<=this._maxLevel){this._doLift(newLvl,this.targets.controls.$btnUp,'up',callback);}else{this.targets.controls.$btnUp.data('busy',false);}},_doLift:function(level,$button,direction,callback){var levelCallback=this._getLevelCallback(level);this._liftContainer(level,$button,callback);if(levelCallback!==null&&typeof levelCallback.callback==='function'){levelCallback.callback(this,level,direction);}},_getLevelCallback:function(level){var currentObj;for(var i=0;i<this.options.callbacks.onLevel.length;i++){currentObj=this.options.callbacks.onLevel[i];if(currentObj.level===level){return currentObj;}}
return null;},_liftContainer:function(level,$button,callback){var _this=this;var height=this._contHeight*level;if(this.options.animateMovement){this.targets.elements.$container.animate({height:height},this.options.animateSpeed,function(){_this._finishLift(level,$button);if(typeof callback==='function'){callback();}});}else{this.targets.elements.$container.css('height',height+'px');this._finishLift(level,$button);if(typeof callback==='function'){callback();}}},_finishLift:function(level,$button){this._setControlState(level);this._saveLevel(level);if(typeof $button!=='undefined'){$button.data('busy',false);}},_liftDown:function(callback){var _this=this;var newLvl=this._curLvl-1;this.targets.controls.$btnDown.data('busy',true);if(newLvl>=this.options.minLevel){this._doLift(newLvl,this.targets.controls.$btnDown,'down',callback);}else{this.targets.controls.$btnDown.data('busy',false);}},_checkWindowHeight:function(){this._maxLevel=this._calculateMaxLevel();if(this._maxLevel<this._curLvl){this._liftContainer(this._maxLevel);}else{this._setControlState(this._curLvl);}},_scrollToNearestLevel:function(moveDirection){var _this=this;var possibleLevel;var heightRatio=this.targets.elements.$container.height()/_this._rowHeight;switch(moveDirection){case'top':possibleLevel=Math.ceil(heightRatio);break;case'bottom':possibleLevel=Math.floor(heightRatio);break;default:possibleLevel=Math.round(heightRatio);break;}
if(possibleLevel>=this._minLevel&&possibleLevel<=this._maxLevel){this._liftContainer(possibleLevel,undefined,function(){if(moveDirection==='top'&&typeof _this.options.callbacks.afterUp==='function'){_this.options.callbacks.afterUp();}
if(moveDirection==='bottom'&&typeof _this.options.callbacks.afterDown==='function'){_this.options.callbacks.afterDown();}});}}})})(jQuery);
;